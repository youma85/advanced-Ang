<div class="board-container">
  <h2>Dispatch Board</h2>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <p>Loading journeys and vehicles...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-state">
      <p class="error-message">Error: {{ error() }}</p>
      <button (click)="store.loadJourneys(); store.loadVehicles()">Retry</button>
    </div>
  }

  <!-- Board Content -->
  @if (!isLoading() && !error()) {
    <div class="board-content">

      <!-- Scheduled Journeys Section -->
      <section class="journey-section">
        <h3>Scheduled Journeys ({{ scheduledJourneys().length }})</h3>
        @if (scheduledJourneys().length === 0) {
          <p class="empty-state">No scheduled journeys</p>
        } @else {
          <div class="journey-list">
            @for (journey of scheduledJourneys(); track journey.id) {
              <div class="journey-card">
                <h4>{{ journey.title }}</h4>
                <p>Status: <span class="status-badge scheduled">{{ journey.status }}</span></p>
                <p>Start: {{ journey.startTime }}</p>
                <p>End: {{ journey.endTime }}</p>

                <!-- Vehicle Assignment Dropdown (Exercise C) -->
                <div class="vehicle-assignment">
                  <label for="vehicle-{{ journey.id }}">Assign Vehicle:</label>
                  <select
                    id="vehicle-{{ journey.id }}"
                    [value]="journey.assignedVehicleId?.toString() || ''"
                    (change)="assignVehicle(journey.id, +$any($event.target).value)"
                    class="vehicle-select"
                  >
                    <option value="">-- No Vehicle --</option>
                    @for (vehicle of vehicles(); track vehicle.id) {
                      <option [value]="vehicle.id.toString()">
                        Vehicle #{{ vehicle.number }} (Capacity: {{ vehicle.capacity }})
                      </option>
                    }
                  </select>
                  @if (journey.assignedVehicleId) {
                    <p class="current-assignment">
                      Currently assigned:
                      @if (getVehicleById(journey.assignedVehicleId); as vehicle) {
                        Vehicle #{{ vehicle.number }}
                      }
                    </p>
                  }
                </div>

                <div class="action-buttons">
                  <button
                    class="btn-start"
                    (click)="store.startJourney(journey.id)"
                    [disabled]="!journey.assignedVehicleId"
                    [title]="!journey.assignedVehicleId ? 'Please assign a vehicle before starting' : 'Start this journey'"
                  >
                    Start Journey
                  </button>
                  <a [routerLink]="['/board/journey', journey.id]" class="btn-link">View Details</a>
                </div>
              </div>
            }
          </div>
        }
      </section>

      <!-- In Progress Journeys Section -->
      <section class="journey-section">
        <h3>In Progress Journeys ({{ inProgressJourneys().length }})</h3>
        @if (inProgressJourneys().length === 0) {
          <p class="empty-state">No journeys in progress</p>
        } @else {
          <div class="journey-list">
            @for (journey of inProgressJourneys(); track journey.id) {
              <div class="journey-card">
                <h4>{{ journey.title }}</h4>
                <p>Status: <span class="status-badge in-progress">{{ journey.status }}</span></p>
                <p>Start: {{ journey.startTime }}</p>
                <p>End: {{ journey.endTime }}</p>

                <!-- Vehicle Assignment - Read Only for In Progress Journeys -->
                <div class="vehicle-assignment">
                  <p><strong>Assigned Vehicle:</strong>
                    @if (journey.assignedVehicleId) {
                      @if (getVehicleById(journey.assignedVehicleId); as vehicle) {
                        Vehicle #{{ vehicle.number }} (Capacity: {{ vehicle.capacity }})
                      } @else {
                        Vehicle ID {{ journey.assignedVehicleId }}
                      }
                    } @else {
                      <span class="no-vehicle">No vehicle assigned</span>
                    }
                  </p>
                  <p class="info-note">Cannot modify vehicle while journey is in progress</p>
                </div>

                <div class="action-buttons">
                  <button
                    class="btn-finish"
                    (click)="store.finishJourney(journey.id)"
                    title="Mark this journey as finished"
                  >
                    Finish Journey
                  </button>
                  <a [routerLink]="['/board/journey', journey.id]" class="btn-link">View Details</a>
                </div>
              </div>
            }
          </div>
        }
      </section>

      <!-- Finished Journeys Section -->
      <section class="journey-section">
        <h3>Finished Journeys ({{ finishedJourneys().length }})</h3>
        @if (finishedJourneys().length === 0) {
          <p class="empty-state">No finished journeys</p>
        } @else {
          <div class="journey-list">
            @for (journey of finishedJourneys(); track journey.id) {
              <div class="journey-card">
                <h4>{{ journey.title }}</h4>
                <p>Status: <span class="status-badge finished">{{ journey.status }}</span></p>
                <p>Start: {{ journey.startTime }}</p>
                <p>End: {{ journey.endTime }}</p>

                <!-- Vehicle Assignment - Read Only for Finished Journeys -->
                <div class="vehicle-assignment">
                  <p><strong>Assigned Vehicle:</strong>
                    @if (journey.assignedVehicleId) {
                      @if (getVehicleById(journey.assignedVehicleId); as vehicle) {
                        Vehicle #{{ vehicle.number }} (Capacity: {{ vehicle.capacity }})
                      } @else {
                        Vehicle ID {{ journey.assignedVehicleId }}
                      }
                    } @else {
                      <span class="no-vehicle">No vehicle assigned</span>
                    }
                  </p>
                  <p class="info-note">Journey completed - vehicle assignment locked</p>
                </div>

                <a [routerLink]="['/board/journey', journey.id]" class="btn-link">View Details</a>
              </div>
            }
          </div>
        }
      </section>

      <!-- Exercise E: @defer for Heavy Views -->
      <!-- This section uses @defer to lazy-load the detailed journey list component -->
      <!-- It only loads when the user scrolls it into view -->
      @defer (on viewport) {
        <app-journey-list-detail />
      } @loading (minimum 500ms) {
        <div class="loading-defer">
          <p>Loading detailed journey view...</p>
          <div class="spinner"></div>
        </div>
      } @error {
        <div class="error-defer">
          <p>Failed to load detailed view</p>
        </div>
      } @placeholder (minimum 1000ms) {
        <div class="placeholder-defer">
          <p>Scroll down to see detailed journey overview</p>
        </div>
      }

      <!-- Available Vehicles Section -->
      <section class="vehicle-section">
        <h3>Available Vehicles ({{ availableVehicles().length }})</h3>
        @if (availableVehicles().length === 0) {
          <p class="empty-state">No available vehicles</p>
        } @else {
          <div class="vehicle-list">
            @for (vehicle of availableVehicles(); track vehicle.id) {
              <div class="vehicle-card">
                <p><strong>Vehicle #{{ vehicle.number }}</strong></p>
                <p>Capacity: {{ vehicle.capacity }} passengers</p>
              </div>
            }
          </div>
        }
      </section>

    </div>
  }

  <!-- Nested router outlet for child routes (/board/journey/:id) -->
  <router-outlet></router-outlet>
</div>
